var list_sentence,list_keyword,list_connection,DATA_URL="",SQL_URL="https://game.youngvoice.tw/",_index_keyword={},_index_connection=0,_sentence="",_keyword=[],_output_blob=null,_snake_crop=null,_output_container=null;function loadData(){$.getJSON(DATA_URL+"data/sentence.json",function(e){list_sentence=e.start,list_connection=e.connect}),$.getJSON(DATA_URL+"data/keyword2.json",function(e){list_keyword=e.keyword}),_index_keyword={noun:0,verb:0,adj:0}}function randomSentence(){return _sentence=list_sentence[Math.floor(Math.random()*list_sentence.length)]}var shuffle=function(e){for(var n,t,o=e.length;0!==o;)t=Math.floor(Math.random()*o),n=e[o-=1],e[o]=e[t],e[t]=n;return e};function randomKeyword(){var e=list_connection[_index_connection].type,n=list_keyword[e][_index_keyword[e]];return _index_keyword[e]++,_index_keyword[e]>=list_keyword[e].length&&(_index_keyword[e]=0,list_keyword[e]=shuffle(list_keyword[e])),n}function randomConnection(){return++_index_connection>=list_connection.length&&(_index_connection=0),list_connection[_index_connection].word}function renderImage(e){var n=mgridx,t=mgridy;for(var o in _body){var a=_body[o].x,r=_body[o].y;a<n&&(n=a),r<t&&(t=r)}n=(n-1)*gwid,t=(t-1)*gwid,_container_snake.x-=n,_container_snake.y-=t,_container_shadow.x-=n,_container_shadow.y-=t,(_snake_crop=new PIXI.Sprite(Texture.EMPTY)).x=0,_snake_crop.y=0,_snake_crop.width=Math.max(_container_snake.width,_container_shadow.width)+2*gwid,_snake_crop.height=Math.max(_container_snake.height,_container_shadow.height)+2*gwid,_container_tmp.addChildAt(_snake_crop,0),app.renderer.render(_container_tmp);var i=app.renderer.extract.canvas(_container_tmp).toDataURL("image/png");$("#dead_wrapper").css("background-image","url("+i+")"),_container_tmp.removeChild(_snake_crop)}function uploadImage(){_container_tmp.visible=!0,null===_output_container&&(_output_container=new Container),_output_container.removeChildren(),_container_game.removeChild(_container_tmp);var e=Math.max(_snake_crop.width,600),n=Math.floor(e/gwid),t=Math.floor(_snake_crop.height/gwid);_graphics_grid.clear();for(var o=0;o<=n;++o)for(var a=0;a<=t;++a)(o+a)%2==0?_graphics_grid.beginFill(15260137,1):_graphics_grid.beginFill(15193320,1),_graphics_grid.drawRect(o*gwid,a*gwid,gwid,gwid),_graphics_grid.endFill();_output_container.addChild(_graphics_grid),_output_container.addChild(_container_tmp),_container_tmp.x=e/2-_container_tmp.width/2,app.renderer.extract.canvas(_output_container).toBlob(function(e){_output_container.removeChild(_graphics_grid),_output_container.removeChild(_container_tmp),_container_game.addChild(_container_tmp),_container_tmp.x=0;var n=new FormData;n.append("action","upload");new File([e],"temp.png");n.append("file",e),$.ajax({type:"POST",url:DATA_URL+"upload/action.php",data:n,processData:!1,contentType:!1,success:function(e){console.log(e),shareImage(e.url),$("#share_button").removeClass("pressed")},error:function(e){console.log(e.responseText)}})},"image/png")}function shareImage(e){var n="https://www.facebook.com/dialog/share?app_id=262109598012691&hashtag="+encodeURIComponent("#青少年不簡單")+"&href="+encodeURIComponent(e)+"&redirect_uri="+encodeURIComponent("https://game.youngvoice.tw/upload/redirect.html");_mobile?window.location.href=n:window.open(n,"_blank")}function getSample(){var e=new FormData;e.append("action","sample");var n="";n=0<_keyword.length?_keyword[Math.floor(Math.random()*_keyword.length)]:randomKeyword(),console.log("get keyword: "+n),e.append("keyword",n),$.ajax({type:"POST",url:SQL_URL+"upload/action.php",data:e,processData:!1,contentType:!1,success:function(e){setSampleText(e)},error:function(e){console.log(e.responseText)}})}var snake_scale,_snake_vel,_last_ms,_last_append,_snake_text_style,_eaten_text_style,_container_tmp,_container_food,_container_snake,_container_shadow,_food_scale,id_loading_font,_frame_intro,_frame_game,_frame_result,_frame_start,_frame_hint,SNAKE_VEL_MIN=32,SNAKE_VEL_MID=24,SNAKE_VEL_MAX=8,SNAKE_ACCELERATE=3,TAIL_APPEND_TIME=500,TRANSITION_TIME=1500,GG_TRANSITION_TIME=3e3,SNAKE_FONT_SIZE=40,SHADOW_OFFSET=5,START_TIMEOUT=500,FOOD_RESET_TIME=400,NEAR_FOOD_THRESHOLD=3,_vel="right",_last_vel="right",_body=[],snake_stop=!0,_angle={left:0,right:180,up:90,down:270},_img_body=[],_shadow_body=[],_img_head=[],_shadow_head=[],_food=[],_food_pattern=[],_food_data=[],_word_eaten=[],_pre_body_pos={},_pre_shadow_pos={};function resetGame(){shuffle(list_keyword.noun),shuffle(list_keyword.verb),shuffle(list_keyword.adj),_index_keyword.noun=0,_index_keyword.verb=0,_index_keyword.adj=0,_index_connection=0,resetSnake(randomSentence()+list_connection[_index_connection].word),resetFood(),_snake_vel=SNAKE_VEL_MIN,_keyword=[],_word_eaten=[],resetSampleText(),$("#dead_wrapper").css("background-image","")}function startGame(){$("#hint_frame").css("display","none"),_last_append=_last_ms=0,app.ticker.add(updateSnake),snake_stop=!1,_food.length<1&&resetFood()}function pauseGame(){snake_stop=!0,app.ticker.remove(updateSnake)}function updateSnake(e){if(!snake_stop&&(_last_append+=e,_snake_vel<=(_last_ms+=e))){if((_last_ms=0)<_word_eaten.length)appendTail(_word_eaten.shift());var n={x:0,y:0},t=_body.length;if(n.x=_body[t-1].x,n.y=_body[t-1].y,"left"===_vel?_body[t-1].x-=1:"up"===_vel?_body[t-1].y-=1:"right"===_vel?_body[t-1].x+=1:"down"===_vel&&(_body[t-1].y+=1),ang=_angle[_vel],_last_vel=_vel,checkSnakePos())_body[t-1].x=n.x,_body[t-1].y=n.y;else for(var o=_body.length-2;0<=o;--o){var a={x:_body[o].x,y:_body[o].y};_body[o].x=n.x,_body[o].y=n.y,n.x=a.x,n.y=a.y}for(o=0;o<_body.length;++o)o==_body.length-1?(setSnakeHead(_container_snake.children[o],_body[o],ang,!1),setSnakeHead(_container_shadow.children[o],_body[o],ang,!0)):0!=o?(setSnakeBody(_container_snake.children[o],_body[o],calBodyDirection(o),!1),setSnakeBody(_container_shadow.children[o],_body[o],calBodyDirection(o),!0)):(setSnakeTail(_container_snake.children[o],_body[o],calTailDirection(),!1),setSnakeTail(_container_shadow.children[o],_body[o],calTailDirection(),!0));app.renderer.render(app.stage)}}function setupSnake(){_container_food=new Container,_container_game.addChild(_container_food),_container_tmp=new Container,_container_game.addChild(_container_tmp),_container_shadow=new Container,_container_tmp.addChild(_container_shadow),_container_snake=new Container,_container_tmp.addChild(_container_snake),_img_head.push(new Texture.from("img/snake/head-normal.png")),_img_head.push(new Texture.from("img/snake/head-eat.png")),_img_head.push(new Texture.from("img/snake/head-dead.png")),_shadow_head.push(new Texture.from("img/snake/shadow-normal.png")),_shadow_head.push(new Texture.from("img/snake/shadow-eat.png")),_shadow_head.push(new Texture.from("img/snake/shadow-dead.png")),_img_body.push(new Texture.from("img/snake/body-horizontal.png")),_img_body.push(new Texture.from("img/snake/body-vertical.png")),_img_body.push(new Texture.from("img/snake/body-left-top.png")),_img_body.push(new Texture.from("img/snake/body-left-bottom.png")),_img_body.push(new Texture.from("img/snake/body-right-top.png")),_img_body.push(new Texture.from("img/snake/body-right-bottom.png")),_shadow_body.push(new Texture.from("img/snake/shadow-horizontal.png")),_shadow_body.push(new Texture.from("img/snake/shadow-vertical.png")),_shadow_body.push(new Texture.from("img/snake/shadow-left-top.png")),_shadow_body.push(new Texture.from("img/snake/shadow-left-bottom.png")),_shadow_body.push(new Texture.from("img/snake/shadow-right-top.png")),_shadow_body.push(new Texture.from("img/snake/shadow-right-bottom.png")),document.addEventListener("keydown",function(e){13!==e.keyCode&&("block"!==$("#hint_frame").css("display")?37===e.which&&"right"!==_last_vel?_vel="left":38===e.which&&"down"!==_last_vel?_vel="up":39===e.which&&"left"!==_last_vel?_vel="right":40===e.which&&"up"!==_last_vel&&(_vel="down"):startGame())});var e=document.getElementById("pixi_frame"),n=new Hammer.Manager(e),t=new Hammer.Swipe({threshold:8,velocity:.2});n.add(t),n.on("swipeleft",function(e){"right"!==_last_vel&&(_vel="left")}),n.on("swiperight",function(e){"left"!==_last_vel&&(_vel="right")}),n.on("swipeup",function(e){"down"!==_last_vel&&(_vel="up")}),n.on("swipedown",function(e){"up"!==_last_vel&&(_vel="down")}),_snake_text_style=new PIXI.TextStyle({fontFamily:"IntroFont",fontSize:gwid/60*SNAKE_FONT_SIZE,fill:1191066}),_eaten_text_style=new PIXI.TextStyle({fontFamily:"IntroFont",fontSize:gwid/60*SNAKE_FONT_SIZE,fill:16777215}),$.getJSON(DATA_URL+"data/food_pattern.json",function(e){for(var n=(_food_data=e.patterns).length,t=0;t<n;++t)_food_data[t].texture=new Texture.from("img/"+_food_data[t].img),_food_data[t].mask=new Texture.from("img/"+_food_data[t].mask);_food_scale=gwid/60;for(t=0;t<3;++t){var o=getFoodOf(2),a=new Sprite(o.texture);a.scale.set(_food_scale);var r=new Container;r.addChild(a);var i=new Sprite(resources["img/food/glow.png"].texture),d=new PIXI.Sprite(o.mask);d.scale.set(_food_scale),r.addChild(d),i.mask=d,app.ticker.add(makeGlower(i)),r.addChild(i),_container_food.addChild(r),_food_pattern.push(o);var _=new Container;_container_food.addChild(_)}}),_container_game.visible=!1}function makeGlower(n){return function(){var e=n.parent.children[0].width;n.x=n.x+3*Math.abs(Math.sin(app.ticker.lastTime)),n.x>e&&(n.x=-e)}}function resetBodyPos(e){_vel="landscape"!==_orientation?"up":"left",_last_vel="landscape"!==_orientation?"down":"right",_body=[],e+=3;for(var n=0;n<e;++n)if("landscape"===_orientation){var t=mgridx-(e-1),o=Math.floor(mgridy/2);_body.push({x:t+n,y:o})}else{t=Math.floor(mgridx/2),o=mgridy-(e-1);_body.push({x:t,y:o+n})}}function resetSnake(e){resetBodyPos(e.length),_container_snake.removeChildren(),_container_snake.x=0,_container_snake.y=0,_container_shadow.removeChildren(),_container_shadow.x=0,_container_shadow.y=0;var n=new Container,t=new Container,o=new Sprite(_shadow_head[0]),a=new Sprite(_img_head[0]);snake_scale=gwid/(a.width/115*60),a.pivot.set(a.width,a.height/2),a.scale.set(snake_scale,snake_scale),a._zIndex=10,o.pivot.set(o.width,o.height/2),o.scale.set(snake_scale,snake_scale),o._zIndex=10,t.addChild(o),n.addChild(a),setSnakeHead(n,_body[0],"landscape"===_orientation?0:90,!1),setSnakeHead(t,_body[0],"landscape"===_orientation?0:90,!0),_container_snake.addChild(n),_container_shadow.addChild(t);for(var r=_body.length,i=0;i<r-2;++i){var d=new Container,_=new Container,s=new Sprite(_img_body[0]);s.scale.set(snake_scale,snake_scale),s._zIndex=0;var l=new Sprite(_shadow_body[0]);l.scale.set(snake_scale,snake_scale),l._zIndex=-10;var c=i<e.length?e[i]:"...",p=new PIXI.Text(c,_snake_text_style);p.scale.set(FONT_STRETCH,1),p._zIndex=10,_.addChild(l),d.addChild(s),d.addChild(p),setSnakeBody(d,_body[i+1],calBodyDirection(i+1),!1),setSnakeBody(_,_body[i+1],calBodyDirection(i+1),!0),_container_snake.addChild(d),_container_shadow.addChild(_)}var g=new Container,h=new Container,u=new Sprite(resources["img/snake/tail.png"].texture);u.pivot.set(u.width,u.height/2),u.scale.set(snake_scale,snake_scale),u._zIndex=0;var m=new Sprite(resources["img/snake/shadow-tail.png"].texture);m.pivot.set(m.width,m.height/2),m.scale.set(snake_scale,snake_scale),m._zIndex=0,h.addChild(m),g.addChild(u),setSnakeTail(g,_body[r-1],"landscape"===_orientation?180:-90,!1),setSnakeTail(h,_body[r-1],"landscape"===_orientation?180:-90,!0),_container_snake.addChild(g),_container_shadow.addChild(h),_container_snake.children.reverse(),_container_shadow.children.reverse(),_body.reverse()}function setSnakeHead(e,n,t,o){var a=e.children[0];a.angle=t,a.x=gwid*(n.x+.5)+gwid/2*Math.cos(a.rotation)+(o?SHADOW_OFFSET:0),a.y=gwid*(n.y+.5)+gwid/2*Math.sin(a.rotation)+(o?SHADOW_OFFSET:0)}function setSnakeBody(e,n,t,o){try{var a=e.children[0];switch(t[0]){case"horiz":a.texture=o?_shadow_body[0]:_img_body[0];break;case"vert":a.texture=o?_shadow_body[1]:_img_body[1];break;case"left-top":a.texture=o?_shadow_body[2]:_img_body[2];break;case"left-bottom":a.texture=o?_shadow_body[3]:_img_body[3];break;case"right-top":a.texture=o?_shadow_body[4]:_img_body[4];break;case"right-bottom":a.texture=o?_shadow_body[5]:_img_body[5]}if(a.x=gwid*n.x+(o?SHADOW_OFFSET:0),a.y=gwid*n.y+(o?SHADOW_OFFSET:0),1<e.children.length){var r=e.children[1];r.x=a.x+SHADOW_OFFSET+(a.width-2*SHADOW_OFFSET)/2-r.width/2,r.y=a.y+SHADOW_OFFSET+(a.height-2*SHADOW_OFFSET)/2-r.height/2}}catch(e){console.log(e)}}function setSnakeTail(e,n,t,o){var a=e.children[0];a.angle=t,a.x=gwid*(n.x+.5)+gwid/2*Math.cos(a.rotation)+(o?SHADOW_OFFSET:0),a.y=gwid*(n.y+.5)+gwid/2*Math.sin(a.rotation)+(o?SHADOW_OFFSET:0)}function checkSnakePos(){var e=_body[_body.length-1].x,n=_body[_body.length-1].y;if(e<0||n<0||mgridx<=e||mgridy<=n)return killSnake(),!0;for(var t=0;t<_body.length-1;++t)if(e==_body[t].x&&n==_body[t].y)return killSnake(),!0;var o=!1;for(var t in _food){var a=_food[t].word.length;for(var r in _food_pattern[t].pattern){var i=_food[t].x+_food_pattern[t].pattern[r].x,d=_food[t].y+_food_pattern[t].pattern[r].y;if(i===e&&d===n){playEatSound();var _=_food[t].word;console.log("eat "+_),_keyword.push(_),(_snake_vel-=SNAKE_ACCELERATE)<SNAKE_VEL_MAX&&(_snake_vel=SNAKE_VEL_MAX);var s=_+randomConnection();_sentence+=s,a=s.length;for(var l=_.length,c=0;c<a;++c){var p={text:s[c],key:c<l};0==_word_eaten.length&&0==c?appendTail(p):_word_eaten.push(p)}return clearFood(),setTimeout(function(){snake_stop||resetFood()},FOOD_RESET_TIME),!1}Math.sqrt(Math.pow(i-e,2)+Math.pow(d-n,2))<NEAR_FOOD_THRESHOLD&&(o=!0)}}_container_shadow.children[_body.length-1].children[0].texture=o?(_container_snake.children[_body.length-1].children[0].texture=_img_head[1],_shadow_head[1]):(_container_snake.children[_body.length-1].children[0].texture=_img_head[0],_shadow_head[0])}function appendTail(e){console.log("append: "+e.text);var n=_body[0].x-_body[1].x,t=_body[0].y-_body[1].y;_body.splice(0,1),_body.splice(0,1);for(var o=_body[0].x+n,a=_body[0].y+t,r=0;r<3;++r)_body.unshift({x:o,y:a}),o+=n,o+=t;var i=_container_snake.removeChildAt(0),d=_container_snake.removeChildAt(0),_=_container_shadow.removeChildAt(0),s=_container_shadow.removeChildAt(0),l=new Container,c=new Container,p=new Sprite(_img_body[0]);p.scale.set(snake_scale,snake_scale),p._zIndex=0;var g=new Sprite(_shadow_body[0]);g.scale.set(snake_scale,snake_scale),g._zIndex=0;var h=new PIXI.Text(e.text,e.key?_eaten_text_style:_snake_text_style);h.scale.set(FONT_STRETCH,1),c.addChild(g),l.addChild(p),l.addChild(h),_container_snake.addChildAt(l,0),_container_shadow.addChildAt(c,0),_container_snake.addChildAt(d,0),_container_shadow.addChildAt(s,0),_container_snake.addChildAt(i,0),_container_shadow.addChildAt(_,0)}function killSnake(){snake_stop=!0;var e=_container_snake.children.length;_container_snake.getChildAt(e-1).children[0].texture=_img_head[2],_container_shadow.getChildAt(e-1).children[0].texture=_shadow_head[2],app.renderer.render(_container_snake),app.ticker.remove(updateSnake),playDeadSound(),_pre_shadow_pos.x=_container_shadow.x,_pre_shadow_pos.y=_container_shadow.y,_pre_body_pos.x=_container_snake.x,_pre_body_pos.y=_container_snake.y,app.ticker.add(shakeBody),setTimeout(function(){app.ticker.remove(shakeBody),_container_snake.x=_pre_shadow_pos.x,_container_snake.y=_pre_shadow_pos.y,_container_shadow.x=_pre_shadow_pos.x,_container_shadow.y=_pre_shadow_pos.y},800),setTimeout(function(){goToResult()},GG_TRANSITION_TIME)}function shakeBody(){_container_snake.x=_pre_shadow_pos.x+10*Math.random()-5,_container_snake.y=_pre_shadow_pos.y+10*Math.random()-5,_container_shadow.x=_pre_shadow_pos.x+10*Math.random()-5,_container_shadow.y=_pre_shadow_pos.y+10*Math.random()-5}function goToResult(){getSample(),$("#signup_button").removeClass("pressed"),$("#share_button").removeClass("pressed"),$("#replay_button").removeClass("pressed"),$("#result_frame").css("display","block"),$("#result_frame").removeClass("hidden"),setTimeout(function(){renderImage(function(){_container_game.visible=!1})},300)}function calBodyDirection(e){try{var n=_body[e+1].x-_body[e-1].x,t=_body[e+1].y-_body[e-1].y,o=_body[e+1].x-_body[e].x,a=_body[e+1].y-_body[e].y,r=Math.floor(180*Math.atan2(t,n)/Math.PI);switch(r){case 0:case 180:return["horiz",r];case 90:case-90:return["vert",r];case 45:return 0<o?["left-bottom",r]:["right-top",r];case 135:return 0<a?["left-top",r]:["right-bottom",r];case-135:return o<0?["right-top",r]:["left-bottom",r];case-45:return a<0?["right-bottom",r]:["left-top",r];default:return console.log("error!!"+e+"-"+n+","+t),["horiz",r]}}catch(e){console.log(e)}}function calTailDirection(){return 180*Math.atan2(_body[1].y-_body[0].y,_body[1].x-_body[0].x)/Math.PI}function getFoodOf(n){var e=_food_data.filter(function(e){return e.mword===n});return e[Math.floor(Math.random()*e.length)]}function clearFood(){_food=[],_food_pattern=[],_container_food.visible=!1,app.renderer.render(_container_food)}function resetFood(){_food=[],_food_pattern=[];for(var e=0;e<3;++e){var n=randomKeyword(),t=getFoodOf(n.length),o=generateFood(t);o.word=n;var a=_container_food.getChildAt(2*e);a.getChildAt(0).texture=t.texture,a.getChildAt(1).texture=t.mask,a.scale.set(_food_scale,_food_scale),a.x=gwid*o.x,a.y=gwid*o.y;var r=_container_food.getChildAt(2*e+1);r.removeChildren(),console.log("food of "+n),r.x=gwid*o.x,r.y=gwid*o.y;for(var i=n.length,d=0;d<i;++d){var _=new PIXI.Text(n[d],_snake_text_style);_.scale.set(FONT_STRETCH,1),_.x=t.pattern[d].x*gwid+gwid/2-_.width/2,_.y=t.pattern[d].y*gwid+gwid/2-_.height/2,r.addChild(_)}_food.push(o),_food_pattern.push(t)}_container_food.visible=!0,0<_keyword.length&&playPopSound()}function generateFood(_){var e=_.mword,s=null,l=null;for(t();n();)t();function n(){for(var e in _.pattern){var n=s+_.pattern[e].x,t=l+_.pattern[e].y;if(n<0||mgridx<=n||t<0||mgridy<=t)return!0;for(var o in _food)for(var a in _food_pattern[o].pattern){var r=_food[o].x+_food_pattern[o].pattern[a].x,i=_food[o].y+_food_pattern[o].pattern[a].y;if(Math.sqrt(Math.pow(r-n,2)+Math.pow(i-t,2))<3)return!0}for(o=0;o<_body.length;o++){var d=_body[o];if(d.x===n&&d.y===t)return!0}}return!1}function t(){s=Math.round(Math.random()*mgridx),l=Math.round(Math.random()*mgridy)}return{x:s,y:l,mword:e}}function rotateVel(e){return"left"===e?"up":"right"===e?"down":"up"===e?"left":"down"===e?"right":void 0}function rotateSnake(){_vel=rotateVel(_vel),_last_vel=rotateVel(_last_vel);for(var e=0,n=0,t=0,o=0,a=0;a<_body.length;++a)_body[a].x>e&&(e=_body[a].x),_body[a].y>n&&(n=_body[a].y),t+=_body[a].x,o+=_body[a].y;t=Math.floor(t/_body.length),o=Math.floor(o/_body.length);var r=Math.floor(o/pre_mgridy*mgridx)-o,i=Math.floor(t/pre_mgridx*mgridy)-t;for(a=0;a<_body.length;++a){var d=_body[a].x;_body[a].x=Math.max(_body[a].y+r,0),_body[a].y=Math.max(d+i,0)}for(a=0;a<_body.length;++a)if(a==_body.length-1){var _="landscape"===_orientation?90:0;setSnakeHead(_container_snake.children[a],_body[a],_,!1),setSnakeHead(_container_shadow.children[a],_body[a],_,!0)}else 0!=a?(setSnakeBody(_container_snake.children[a],_body[a],calBodyDirection(a),!1),setSnakeBody(_container_shadow.children[a],_body[a],calBodyDirection(a),!0)):(setSnakeTail(_container_snake.children[a],_body[a],calTailDirection(),!1),setSnakeTail(_container_shadow.children[a],_body[a],calTailDirection(),!0))}function resetFoodPos(){for(var e in _food){var n=generateFood(_food_pattern[e]);_food[e].x=n.x,_food[e].y=n.y;var t=_container_food.getChildAt(2*e);t.x=gwid*n.x,t.y=gwid*n.y;var o=_container_food.getChildAt(2*e+1);o.x=gwid*n.x,o.y=gwid*n.y}}function loadPreElement(){loader.add(["img/logo.png","img/textrunner/text-01.png","img/textrunner/text-03.png","img/textrunner/text-04.png","img/textrunner/text-05.png","img/textrunner/text-06.png","img/textrunner/text-07.png","img/textrunner/text-08.png","img/textrunner/text-09.png","img/textrunner/text-10.png","img/textrunner/text-12.png","img/textrunner/text-13.png","img/textrunner/text-14.png","img/textrunner/text-15.png","img/textrunner/text-16.png","img/textrunner/text-17.png","img/textrunner/text-18.png","img/textrunner/text-19.png","img/textrunner/text-20.png","img/textrunner/text-21.png","img/textrunner/text-22.png","img/textrunner/text-23.png","img/textrunner/text-24.png","img/textrunner/text-25.png","img/textrunner/text-26.png","img/textrunner/text-27.png","img/textrunner/text-28.png","img/textrunner/text-29.png","img/textrunner/text-31.png","img/textrunner/text-33.png"]).load(function(){console.log("finish preloading!"),loadFont(),loadMusic()})}function loadGame(){loader.add(["img/hint-mobile.png","img/hint-pc.png","img/snake/head-normal.png","img/snake/head-eat.png","img/snake/head-dead.png","img/snake/body-horizontal.png","img/snake/body-vertical.png","img/snake/body-left-top.png","img/snake/body-left-bottom.png","img/snake/body-right-top.png","img/snake/body-right-bottom.png","img/snake/tail.png","img/snake/shadow-normal.png","img/snake/shadow-eat.png","img/snake/shadow-dead.png","img/snake/shadow-horizontal.png","img/snake/shadow-vertical.png","img/snake/shadow-left-top.png","img/snake/shadow-left-bottom.png","img/snake/shadow-right-top.png","img/snake/shadow-right-bottom.png","img/snake/shadow-tail.png","img/food/glow.png","img/food/2-1.png","img/food/2-2.png","img/food/3-1.png","img/food/3-2.png","img/food/3-3.png","img/food/3-4.png","img/food/4.png","img/food/5-1.png","img/food/5-2.png","img/food/5-3.png","img/food/5-4.png","img/food/mask-2-1.png","img/food/mask-2-2.png","img/food/mask-3-1.png","img/food/mask-3-2.png","img/food/mask-3-3.png","img/food/mask-3-4.png","img/food/mask-4.png","img/food/mask-5-1.png","img/food/mask-5-2.png","img/food/mask-5-3.png","img/food/mask-5-4.png"]).on("progress",loadProgressHandler).load(function(){setup(),console.log("finish loading fame!")})}function loadFont(){WebFont.load({custom:{families:["IntroFont"]},google:{families:["Noto Sans TC"]},loading:loadFontFinish}),id_loading_font=setInterval(loadingSnake,300)}function loadFontFinish(){console.log("finish loading font!"),clearInterval(id_loading_font),progress_after_font=loading_progress,loadGame()}function setup(){showStart(),loadData(),(_container_game=new PIXI.Container).visible=!0,app.stage.addChild(_container_game),setupRunner(),setupGrid(),setupSnake()}function showStart(){$("#start_button").css("display","block"),$("#loading_bar").css("display","none")}function setupGrid(){_graphics_grid=new PIXI.Graphics,resetGrid()}function resetGrid(){if(null!==_graphics_grid){_graphics_grid.clear();for(var e=0;e<=mgridx;++e)for(var n=0;n<=mgridy;++n)(e+n)%2==0?_graphics_grid.beginFill(15260137,1):_graphics_grid.beginFill(15193320,1),_graphics_grid.drawRect(e*gwid,n*gwid,gwid,gwid),_graphics_grid.endFill();app.stage.addChild(_container_game),app.renderer.render(app.stage)}}function setSampleText(e){"empty"===e.type?document.getElementById("sample_text").innerHTML="oops! 資料庫建置中!":(document.getElementById("sample_title").innerHTML=e.title,document.getElementById("sample_text").innerHTML=e.text,"text"!==e.type?(document.getElementById("sample_image").src=e.imgurl,$("#sample_image_wrapper").css("display","block")):$("#sample_image_wrapper").css("display","none"))}function resetSampleText(){document.getElementById("sample_text").innerHTML="",document.getElementById("sample_image").src=""}var Container,autoDetectRenderer,loader,resources,Sprite,Texture,Rectangle,type,app,wid,whei,FRAME_BORDER,_bar_snake,_bar,_img_music,_btn_music,_play_music,_img_start,_img_iknow,_img_share,_img_replay,_img_signup,_container_game,_sample_content,_sample_title_text,_recommand_back,_first_intro=!1,_display_intro=!1;function onClickStart(){playButtonSound(),$("#start_button").addClass("pressed"),setTimeout(function(){$("#start_frame").addClass("hidden"),_first_intro?(resetGame(),showGame()):(_first_intro=!0,$("#intro_frame").css("display","block"),$("#iknow_button").removeClass("pressed"),_display_intro=!0,setTimeout(function(){$("#intro_frame").removeClass("hidden")},10),setTimeout(function(){$("#start_frame").css("display","none"),playBackMusic()},300))},300)}function showGame(){_container_game.visible=!0,$("#hint_frame").css("display","block"),$("#hint_frame").removeClass("hidden"),setTimeout(function(){$("#start_frame").css("display","none")},10)}function onClickIknow(){playButtonSound(),$("#iknow_button").addClass("pressed"),setTimeout(function(){$("#intro_frame").addClass("hidden"),setTimeout(function(){$("#intro_frame").css("display","none"),_display_intro=!1,_first_intro?(resetGame(),showGame(),_first_intro=!1):_container_game.visible&&startGame()},10)},100)}function onClickReplay(){playButtonSound(),$("#replay_button").addClass("pressed"),setTimeout(function(){$("#result_frame").addClass("hidden"),setTimeout(function(){$("#result_frame").css("display","none"),resetGame(),showGame()},100)},100)}function onClickShare(){playButtonSound(),$("#share_button").addClass("pressed"),setTimeout(function(){uploadImage()},50)}function onClickSignUp(){playButtonSound(),$("#signup_button").addClass("pressed"),setTimeout(function(){_mobile?window.location.href="http://www.youngvoice.tw/content/award/award_index.aspx?id=10":window.open("http://www.youngvoice.tw/content/award/award_index.aspx?id=10","_blank")},100)}function onClickWebsite(){playButtonSound(),setTimeout(function(){_mobile?window.location.href="http://www.youngvoice.tw":window.open("http://www.youngvoice.tw","_blank")},100)}function onClickTitle(){"block"!==$("#start_frame").css("display")&&(pauseGame(),"block"===$("result_frame").css("display")?$("#result_frame").addClass("hidden"):"block"===$("intro_frame").css("display")&&$("#intro_frame").addClass("hidden"),setTimeout(function(){$("#result_frame").css("display","none"),$("#intro_frame").css("display","none"),$("#start_frame").css("display","block"),$("#start_frame").removeClass("hidden"),$("#start_button").removeClass("pressed")},300))}function onClickHint(){"block"===$("#hint_frame").css("display")&&startGame()}function resetIntro(){_img_start.frame=new Rectangle(0,0,323,84)}function toggleIntro(){(_display_intro=!_display_intro)?($("#intro_frame").css("display","block"),$("#intro_frame").removeClass("hidden"),$("#iknow_button").removeClass("pressed"),setTimeout(function(){pauseGame()},300)):($("#intro_frame").addClass("hidden"),setTimeout(function(){$("#intro_frame").css("display","none"),_container_game.visible&&startGame()},300))}window.onload=function(){_mobile?document.getElementById("hint_image").src="img/hint-mobile.png":document.getElementById("hint_image").src="img/hint-pc.png"};var offsetx,offsety,button_scale,marginx,marginy,landscape,_title_hei,pre_wid,pre_hei,pre_mgridx,pre_mgridy,mgridx,mgridy,_orientation,_resizing,_graphics_grid=null,MIN_GRID=10,MAX_GRID=18,gwid=60,text_margin=2*FRAME_BORDER;function setupPixi(){Container=PIXI.Container,autoDetectRenderer=PIXI.autoDetectRenderer,loader=PIXI.loader,resources=PIXI.loader.resources,Sprite=PIXI.Sprite,Texture=PIXI.Texture,Rectangle=PIXI.Rectangle,type="WebGL",PIXI.utils.isWebGLSupported()||(type="canvas"),(app=new PIXI.Application({autoResize:!0,resolution:devicePixelRatio,antialias:!0,transparent:!0})).renderer.backgroundColor=398905,document.getElementById("pixi_frame").appendChild(app.view),wwid=app.screen.width,whei=app.screen.height,FRAME_BORDER=5,window.addEventListener("resize",resize),doResize()}function resize(){clearTimeout(_resizing),_resizing=setTimeout(doResize,100)}function doResize(){var e=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,n=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;console.log("window size:"+e+" x "+n);var t=.99*e,o=.99*n,a=$("#frame_title").height(),r=t-5-13,i=o-a-10-13;t=60*Math.floor(r/60),o=60*Math.floor(i/60),$("#outer_frame").css("width",t+13+5+"px"),$("#outer_frame").css("height",o+a+10+13+"px"),$("#outer_frame").css("left",(e-8)/2-(t+18)/2+"px"),$("#outer_frame").css("top",n/2-(o+a+23)/2+"px"),$("#inner_frame").css("min-height",o+"px"),app.stage.removeChild(_container_game),app.renderer.resize(t,o),pre_wid=wwid,pre_hei=whei,wwid=t,whei=o,console.log("reset size:"+wwid+" x "+whei);var d=wwid>whei?"landscape":"portrait";offsety=(offsetx=FRAME_BORDER)/2,pre_mgridx=mgridx,pre_mgridy=mgridy,mgridx=Math.floor(wwid/gwid),mgridy=Math.floor(whei/gwid),console.log(mgridx+" "+(wwid-gwid*mgridx)+" x "+mgridy+" "+(whei-gwid*mgridy)),resetGrid(),_orientation&&d!=_orientation&&(rotateSnake(),resetFoodPos()),_orientation=d}var progress_after_font,_sound_back,_sound_eat,_sound_dead,_sound_pop,_sound_button,loading_progress=0;function loadingSnake(){loading_progress=Math.min(loading_progress+1,20),setLoadingProgress()}function loadProgressHandler(e,n){loading_progress=(100-progress_after_font)/100*e.progress+progress_after_font,setLoadingProgress()}function setLoadingProgress(){var e=2.77*loading_progress+20;$("#loading_snake_body").css("width",e),$("#loading_snake_head").css("left",e+33)}var _play_sound=!0;function loadMusic(){_sound_back=new Howl({src:["sound/back.wav","sound/back.ogg"],loop:!0,onend:function(){},onplayerror:function(){_sound_back.once("unlock",function(){_sound_back.play()})}}),_sound_eat=new Howl({src:["sound/eat.wav","sound/eat.ogg"]}),_sound_dead=new Howl({src:["sound/dead.wav","sound/dead.ogg"]}),_sound_pop=new Howl({src:["sound/pop.wav","sound/pop.ogg"]}),_sound_button=new Howl({src:["sound/button.wav","sound/button.ogg"]}),_play_sound=!1}function toggleMusic(){(_play_sound=!_play_sound)?(_sound_back.play(),$("#music_button_off").addClass("hidden"),$("#music_button_on").removeClass("hidden")):(_sound_back.pause(),$("#music_button_on").addClass("hidden"),$("#music_button_off").removeClass("hidden"))}function playBackMusic(){_play_sound||(console.log("play bgm!!"),_play_sound=!0,_sound_back.play(),$("#music_button_off").addClass("hidden"),$("#music_button_on").removeClass("hidden"))}function playEatSound(){_play_sound&&_sound_eat.play()}function playDeadSound(){_play_sound&&_sound_dead.play()}function playPopSound(){_play_sound&&_sound_pop.play()}function playButtonSound(){_play_sound&&_sound_button.play()}var app_runner,_textrunner,FONT_STRETCH=.7,RunnerText=[["01","01","03","04","05","06","07","33","17","18","08","09","10","03","12","13","14"],["15","16","19","20","21","22","23","24","33","25","26","27","28","33","29","29","31","31"]],_runner_sentence_index=0,_runner_word_index=0;function setupRunner(){for(var e in app_runner=new PIXI.Application({width:500,height:100,autoResize:!0,resolution:devicePixelRatio,antialias:!0,transparent:!0}),document.getElementById("loading_text").appendChild(app_runner.view),app_runner.renderer.view.style.position="relative",app_runner.renderer.view.style.top="auto",app_runner.renderer.view.style.bottom="20%",(_textrunner=new PIXI.Container).height=50,_textrunner.y=50,drawTextRunner(0),_textrunner.x=0,RunnerText){var n=new PIXI.Container;e!=_runner_sentence_index&&(n.visible=!1);var t=0;for(var o in RunnerText[e]){var a=new Texture.from("img/textrunner/text-"+RunnerText[e][o]+".png"),r=new PIXI.Sprite(a);r.scale.set(FONT_STRETCH,1),r.x=t,r.y=0,t+=r.width+.2*r.width,n.addChild(r)}_textrunner.addChild(n)}for(var e in app_runner.stage.addChild(_textrunner),app_runner.ticker.add(function(e){drawTextRunner(e)}),_textrunner.children)_textrunner.children[e].x=250-_textrunner.children[e].width/2}function drawTextRunner(e){if(!(_textrunner.children.length<1)){_runner_word_index+=app_runner.ticker.deltaMS/150;new PIXI.TextStyle({fontFamily:"SnakeFont",fontSize:36,fill:1191066,letterSpacing:2,fontWeight:"bold"});for(var n=_textrunner.children[_runner_sentence_index].children.length,t=0;t<n;++t){var o=Math.floor(_runner_word_index);_textrunner.children[_runner_sentence_index].children[t].y=t==o?-12:t==o-1||t==o+1?-6:0}if(n<=_runner_word_index)for(var t in _runner_sentence_index=(_runner_sentence_index+1)%RunnerText.length,_runner_word_index=0,n=RunnerText[_runner_sentence_index].length,_textrunner.children)_textrunner.children[t].visible=t==_runner_sentence_index}}